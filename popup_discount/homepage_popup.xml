<odoo>
  <template id="homepage_popup_script_injection" name="Popup Email Capture Injection" inherit_id="website.layout">
    <xpath expr="//body" position="inside">
      <script type="module">
        <![CDATA[
          console.log("ðŸš€ Popup module script loaded");

          document.addEventListener("DOMContentLoaded", async function () {
            try {
              const statusRes = await fetch("/newsletter/status", {
                method: "POST",
                headers: { "Content-Type": "application/json" }
              });
              const status = await statusRes.json();
              const alreadyClosed = sessionStorage.getItem("popup_closed");

              if (!status.email_registered && !alreadyClosed) {
                const popup = document.createElement("div");
                popup.id = "main-discount-popup-container";
                popup.innerHTML = `
                  <div style="position:fixed;top:20%;left:50%;transform:translateX(-50%);
                              background:#fff;padding:20px;border-radius:8px;box-shadow:0 0 10px rgba(0,0,0,0.5);z-index:9999;">
                    <h3>ðŸŽ‰ Â¡ObtÃ©n un 5% de descuento!</h3>
                    <p>Introduce tu correo electrÃ³nico para recibir tu cÃ³digo exclusivo.</p>
                    <input type="email" id="popup_email" placeholder="Tu correo" style="width: calc(100% - 22px); padding: 8px; margin-bottom: 10px; border: 1px solid #ccc; border-radius: 4px;" />
                    <button id="popup_send_email_button" style="background-color: rgb(46, 76, 30); color: white; padding: 10px 15px; border: none; border-radius: 4px; cursor: pointer;">Enviar</button>
                    <button id="popup_close_button" style="background-color: #dc3545; color: white; padding: 10px 15px; border: none; border-radius: 4px; cursor: pointer; margin-left: 10px;">X</button>
                  </div>
                `;
                document.body.appendChild(popup);

                document.getElementById('popup_close_button').addEventListener('click', function() {
                  document.getElementById('main-discount-popup-container').remove();
                  sessionStorage.setItem("popup_closed", "true");
                });

                document.getElementById('popup_send_email_button').addEventListener('click', async function() {
                  const email = document.getElementById("popup_email").value;
                  if (!email) {
                    alert("Por favor, insira um email vÃ¡lido.");
                    return;
                  }

                  try {
                    const res = await fetch("/newsletter/popup", {
                      method: "POST",
                      headers: { "Content-Type": "application/json" },
                      body: JSON.stringify({ email })
                    });
                    const json = await res.json();
                    if (json.status === "ok") {
                      alert("Â¡Correo enviado! Revisa tu bandeja.");
                      document.getElementById('main-discount-popup-container').remove();
                      sessionStorage.setItem("popup_closed", "true");
                    } else {
                      alert(json.message || "Erro ao enviar.");
                    }
                  } catch (err) {
                    alert("Erro de rede.");
                  }
                });
              }
            } catch (error) {
              console.error("Erro ao carregar popup:", error);
            }
          });
        ]]>
      </script>
    </xpath>
  </template>
</odoo>


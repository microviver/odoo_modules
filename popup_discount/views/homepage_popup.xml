<odoo>
  <template id="homepage_popup_script_injection" name="Popup Email Capture Injection" inherit_id="website.layout">
    <xpath expr="//body" position="inside">
      <script type="module">
        <![CDATA[
          console.log("ðŸš€ Popup module script started loading.");

          document.addEventListener("DOMContentLoaded", function () {
            console.log("âœ… DOMContentLoaded fired. Checking popup_shown status.");

            // Remova ou comente a linha abaixo em produÃ§Ã£o. Ela Ã© Ãºtil apenas para testes.
            // localStorage.removeItem("popup_shown");

            // Verifica se o usuÃ¡rio jÃ¡ viu o popup ou se Ã© um usuÃ¡rio logado com desconto.
            // PoderÃ­amos fazer uma chamada ao backend aqui para verificar se o usuÃ¡rio logado jÃ¡ tem um cÃ³digo.
            if (!localStorage.getItem("popup_shown")) {
              console.log("LocalStorage 'popup_shown' not found. Creating popup.");
              var popup = document.createElement("div");
              popup.id = "main-discount-popup-container";
              popup.innerHTML = `
                <div style="position:fixed;top:20%;left:50%;transform:translateX(-50%);
                            background:#fff;padding:20px;border-radius:8px;box-shadow:0 0 10px rgba(0,0,0,0.5);z-index:9999;">
                  <h3>ðŸŽ‰ Â¡ObtÃ©n un 5% de desconto!</h3>
                  <p>Introduce tu correo electrÃ³nico para recibir tu cÃ³digo exclusivo.</p>
                  <input type="email" id="popup_email" placeholder="Tu correo" style="width: calc(100% - 22px); padding: 8px; margin-bottom: 10px; border: 1px solid #ccc; border-radius: 4px;" />
                  <button id="popup_send_email_button" style="background-color: rgb(46, 76, 30); color: white; padding: 10px 15px; border: none; border-radius: 4px; cursor: pointer;">Enviar</button>
                  <button id="popup_close_button" style="background-color: #dc3545; color: white; padding: 10px 15px; border: none; border-radius: 4px; cursor: pointer; margin-left: 10px;">X</button>
                  <p id="popup_message" style="color: red; margin-top: 10px;"></p>
                </div>
              `;
              document.body.appendChild(popup);
              localStorage.setItem("popup_shown", "true");
              console.log("ðŸŒŸ Popup added to DOM and popup_shown set in localStorage.");

              document.getElementById('popup_send_email_button').addEventListener('click', enviarCorreo);
              document.getElementById('popup_close_button').addEventListener('click', function() {
                  document.getElementById('main-discount-popup-container').remove();
                  console.log("Popup closed by user.");
              });

            } else {
              console.log("ðŸ’¡ Popup not shown. 'popup_shown' already exists in localStorage.");
            }
          });

          window.enviarCorreo = async function() {
            var emailInput = document.getElementById("popup_email");
            var email = emailInput.value;
            var messageElement = document.getElementById("popup_message");
            messageElement.textContent = ""; // Limpa mensagens anteriores

            if (!email) {
                messageElement.textContent = "Por favor, insira o seu e-mail.";
                emailInput.focus();
                return;
            }

            // Simple email validation
            if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
                messageElement.textContent = "Por favor, insira um e-mail vÃ¡lido.";
                emailInput.focus();
                return;
            }

            console.log("Attempting to send email:", email);
            try {
                const response = await fetch("/newsletter/popup", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                    },
                    body: JSON.stringify({ email: email }),
                });

                const data = await response.json(); // Sempre tentar ler a resposta JSON

                if (response.ok) {
                    if (data.status === 'ok') {
                        alert("Â¡Correo enviado! Revisa tu bandeja.");
                        document.getElementById('main-discount-popup-container').remove();
                    } else if (data.status === 'exists') {
                        alert("Este e-mail jÃ¡ tem um cÃ³digo de desconto registado. Verifique a sua caixa de entrada.");
                        document.getElementById('main-discount-popup-container').remove();
                    } else {
                        // This case should ideally not happen if backend consistently sends 'ok' or 'exists' for success
                        alert(`Ocorreu um erro inesperado: ${data.message || 'Resposta desconhecida'}`);
                        console.error("Unexpected server response:", data);
                    }
                } else {
                    alert(`Ocorreu um erro: ${data.message || response.statusText}`);
                    console.error("Server error:", data);
                }
            } catch (error) {
                alert("Ocorreu um erro de rede ou servidor.");
                console.error("Fetch error:", error);
            }
          };
        ]]>
      </script>
    </xpath>
  </template>
</odoo>
